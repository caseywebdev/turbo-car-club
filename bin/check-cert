#!/bin/bash -e

LE_DIR=/etc/letsencrypt/live
CERT_PATH=$LE_DIR/fullchain.pem
KEY_PATH=$LE_DIR/privkey.pem
KV_URL=$CONSUL_URL/v1/kv/letsencrypt

if [ "$LETSENCRYPT_ENABLED" = "1" ]; then
  echo 'Pulling key from consul'
  curl -s $KV_URL/privkey.pem?raw > $KEY_PATH

  echo 'Pulling cert from consul'
  curl -s $KV_URL/fullchain.pem?raw > $CERT_PATH

  if openssl x509 -checkend 86400 -noout -in $CERT_PATH; then
    echo 'Cert is good for at least 24 more hours'
  else
    echo 'Cert is out of date or does not exist'

    echo 'Waiting for nginx to start'
    while [ ! "`ps aux | grep [n]ginx`" ]; do sleep 1; done

    echo 'Requesting cert from letsencrypt'
    certbot-auto -n certonly --webroot \
      -w /usr/local/nginx/html \
      -d $CLIENT_SERVER_NAME \
      -d $SIGNAL_SERVER_NAME \
      -d $CONSUL_SERVER_NAME

    echo 'Reloading nginx'
    nginx -s reload

    echo 'Saving key to consul'
    curl -sXPUT $KV_URL/privkey.pem --data-binary @$KEY_PATH

    echo 'Saving cert to consul'
    curl -sXPUT $KV_URL/fullchain.pem --data-binary @$CERT_PATH
  fi
fi
