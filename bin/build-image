#!/usr/bin/env bash -e

REF=${1:-master}
REPO=caseywebdev/turbo-car-club
SHA=`curl https://api.github.com/repos/$REPO/commits/$REF | jq -r .sha`
REPO_URL=https://api.github.com/repos/$REPO/tarball/$SHA
IMAGE=quay.io/caseywebdev/turbo-car-club:$SHA
TMP=/tmp/$IMAGE

rm -fr $TMP
mkdir -p $TMP
curl -sSL $REPO_URL | tar xz --strip-components 1 -C $TMP
cd $TMP

echo "Building $IMAGE"
docker build -t $IMAGE .

rm -fr $TMP

echo "Pushing $IMAGE"
docker push $IMAGE

echo "Successfully built and pushed $IMAGE"
